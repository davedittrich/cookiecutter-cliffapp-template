name: Cookicutter template validation workflow

on: [ push, pull_request ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      PY_COLORS: 1
      TOX_PARALLEL_NO_SPINNER: 1
    steps:
    - name: Check out src from GitHub
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - uses: conda-incubator/setup-miniconda@v2
      with:
        auto-activate-base: true
        python-version: 3.8
        auto-update-conda: true
    - name: Install dependencies
      run: |
        conda config --set always_yes yes --set changeps1 no
        python3 -m pip install tox setuptools>=42 setuptools_scm wheel twine
        [ -f requirements.txt ] && python3 -m pip install -Ur requirements.txt
        [ -f test-requirements.txt ] && python3 -m pip install -Ur test-requirements.txt
        echo "VERSION=$(python3 setup.py --version)"
        make bats-libraries
        # Useful for debugging any issues with conda
        conda info -a
    - name: Get variables
      id: get_vars
      run: |
        REPO=$(basename ${{ github.repository }})
        echo "REPO=${REPO}"
        echo ::set-output name=REPO::${REPO}

        BRANCH=${GITHUB_REF##*/}
        echo "BRANCH=${BRANCH}"
        echo ::set-output name=BRANCH::${BRANCH}

        VERSION=$(python3 setup.py --version 2>/dev/null)
        echo "VERSION=${VERSION}"
        echo ::set-output name=VERSION::${VERSION}

        TAG_VERSION=$(git describe --abbrev=0 --tags)
        echo "TAG_VERSION=${TAG_VERSION}"
        echo ::set-output name=TAG_VERSION::${TAG_VERSION}

        ARTIFACT="${REPO}-${BRANCH}"
        echo "ARTIFACT=${ARTIFACT}"
        echo ::set-output name=ARTIFACT::${REPO}-${BRANCH}
    - name: Generate example project
      run: |
        cookiecutter --no-input . package_name=example
    - name: Run tests
      run: make test
